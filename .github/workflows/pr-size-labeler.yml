name: PR Size Labeler

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Label PR by size
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = context.payload.pull_request.number;

            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber,
            });

            const additions = pr.additions;
            const deletions = pr.deletions;
            const changedFiles = pr.changed_files;

            // Simple, hackathon-friendly heuristic
            const score = additions + deletions;

            let size;
            if (score < 50) size = "size-XS";
            else if (score < 200) size = "size-S";
            else if (score < 500) size = "size-M";
            else if (score < 1000) size = "size-L";
            else size = "size-XL";

            const allSizes = ["size-XS", "size-S", "size-M", "size-L", "size-XL"];

            // Remove old size labels
            for (const label of allSizes) {
              try {
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: prNumber,
                  name: label,
                });
              } catch (e) {}
            }

            // Ensure label exists (create if missing)
            const { data: repoLabels } = await github.rest.issues.listLabelsForRepo({
              owner,
              repo,
              per_page: 100,
            });

            const exists = repoLabels.some(l => l.name === size);
            if (!exists) {
              await github.rest.issues.createLabel({
                owner,
                repo,
                name: size,
                color: "5319e7",
                description: "Auto-labeled by PR size",
              });
            }

            // Add size label to PR (PRs are issues)
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: prNumber,
              labels: [size],
            });

            core.info(`PR #${prNumber}: +${additions} -${deletions} files:${changedFiles} => ${size}`);
